<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG Report Generator - Split API Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .step.completed {
            border-color: #4caf50;
        }

        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }

        button:hover:not(:disabled) {
            background: #5568d3;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        select, input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 6px;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success { background: #d4edda; color: #155724; }
        .result.error { background: #f8d7da; color: #721c24; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä ESG Report Generator</h1>
            <p>Split API with Change Analysis</p>
        </div>

        <div class="content">
            <!-- Step 1: Compare Columns -->
            <div class="step" id="step1">
                <h2>Step 1: Upload & Compare Columns</h2>
                <select id="template">
                    <option value="">Select Template...</option>
                    <option value="ADX_ESG">ADX ESG Template</option>
                    <option value="DIFC_ESG">DIFC ESG Template</option>
                    <option value="MOCCAE">MOCCAE Compliance Template</option>
                    <option value="SCHOOLS">Schools Lite Template</option>
                    <option value="SME">SME Lite Template</option>
                </select>
                <input type="file" id="file" accept=".csv,.xlsx,.xls,.docx">
                <button onclick="compareColumns()">Upload & Compare</button>
                <div id="loading1" class="loading"><div class="spinner"></div><p>Analyzing...</p></div>
                <div id="result1" class="result"></div>
            </div>

            <!-- Step 2: Map Columns -->
            <div class="step" id="step2">
                <h2>Step 2: Confirm Mappings & Process</h2>
                <div id="mappings"></div>
                <button onclick="mapColumns()" id="mapBtn" disabled>Confirm & Process</button>
                <div id="loading2" class="loading"><div class="spinner"></div><p>Processing...</p></div>
                <div id="result2" class="result"></div>
            </div>

            <!-- Step 3: View Results -->
            <div class="step" id="step3">
                <h2>Step 3: View Change Analysis</h2>
                <div id="changeAnalysis"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let fileId = null;
        let templateCols = [];
        let uploadedCols = [];
        let mappings = [];

        async function compareColumns() {
            const file = document.getElementById('file').files[0];
            const template = document.getElementById('template').value;
            
            if (!file || !template) {
                alert('Please select both file and template');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('template', template);

            document.getElementById('loading1').style.display = 'block';
            
            try {
                const res = await fetch(`${API_BASE}/compare-columns`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    fileId = data.file_id;
                    templateCols = data.template_columns;
                    uploadedCols = data.uploaded_columns;
                    
                    showResult('result1', `‚úÖ Success! Found ${uploadedCols.length} columns`, 'success');
                    document.getElementById('step1').classList.add('completed');
                    
                    // Auto-create mappings
                    mappings = templateCols.map(tc => ({
                        template_column: tc,
                        uploaded_column: uploadedCols.find(uc => uc.toLowerCase() === tc.toLowerCase()) || null
                    }));
                    
                    // Show mappings UI
                    let html = `<p><strong>${mappings.filter(m => m.uploaded_column).length}</strong> of ${templateCols.length} columns auto-matched</p>`;
                    document.getElementById('mappings').innerHTML = html;
                    document.getElementById('mapBtn').disabled = false;
                } else {
                    showResult('result1', `‚ùå Error: ${data.detail}`, 'error');
                }
            } catch (error) {
                showResult('result1', `‚ùå Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading1').style.display = 'none';
            }
        }

        async function mapColumns() {
            document.getElementById('loading2').style.display = 'block';
            
            try {
                const res = await fetch(`${API_BASE}/map-columns`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: fileId,
                        mappings: mappings
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showResult('result2', `‚úÖ Processed ${data.data.length} records`, 'success');
                    document.getElementById('step2').classList.add('completed');
                    
                    // Show change analysis
                    displayChangeAnalysis(data.data);
                } else {
                    showResult('result2', `‚ùå Error: ${data.detail}`, 'error');
                }
            } catch (error) {
                showResult('result2', `‚ùå Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading2').style.display = 'none';
            }
        }

        function displayChangeAnalysis(data) {
            const improved = data.filter(r => r.status === 'improved').length;
            const worsened = data.filter(r => r.status === 'worsened').length;
            const slight = data.filter(r => r.status === 'slight').length;
            const noData = data.filter(r => !r.status).length;
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-box" style="background: #d4edda;">
                        <h3 style="color: #155724;">‚úÖ ${improved}</h3>
                        <p style="color: #155724;">Improved</p>
                    </div>
                    <div class="stat-box" style="background: #f8d7da;">
                        <h3 style="color: #721c24;">‚ùå ${worsened}</h3>
                        <p style="color: #721c24;">Worsened</p>
                    </div>
                    <div class="stat-box" style="background: #fff3cd;">
                        <h3 style="color: #856404;">‚ö†Ô∏è ${slight}</h3>
                        <p style="color: #856404;">Slight</p>
                    </div>
                    <div class="stat-box" style="background: #e2e3e5;">
                        <h3 style="color: #383d41;">‚äù ${noData}</h3>
                        <p style="color: #383d41;">No Data</p>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Sample Records with Change Analysis:</h3>
            `;
            
            // Show first 3 records with change data
            data.slice(0, 3).forEach((record, i) => {
                if (record.change_percentage !== null && record.change_percentage !== undefined) {
                    const statusIcon = record.status === 'improved' ? '‚úÖ' : 
                                     record.status === 'worsened' ? '‚ùå' : '‚ö†Ô∏è';
                    html += `
                        <div style="padding: 15px; margin: 10px 0; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                            <strong>${record['Field (EN)'] || record['field'] || 'Field ' + (i+1)}</strong>
                            <div style="margin-top: 8px;">
                                <span style="margin-right: 15px;">Prev: ${record['Prev Year'] || record['prev_year'] || 'N/A'}</span>
                                <span style="margin-right: 15px;">Current: ${record['Current'] || record['current'] || 'N/A'}</span>
                                <span style="font-weight: bold; color: ${record.status === 'improved' ? '#155724' : record.status === 'worsened' ? '#721c24' : '#856404'};">
                                    ${statusIcon} ${record.change_percentage.toFixed(1)}% (${record.status})
                                </span>
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('changeAnalysis').innerHTML = html;
        }

        function showResult(id, msg, type) {
            const el = document.getElementById(id);
            el.className = `result ${type}`;
            el.innerHTML = msg;
            el.style.display = 'block';
        }
    </script>
</body>
</html>
